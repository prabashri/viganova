---
// src/components/ShareLink.astro
import { Icon } from 'astro-icon/components';
import { siteDefaults } from '@/config/siteDefaults';
import IconMask from '@/components/IconMask.astro';

interface Props {
  id?: string;
  title?: string;
  url?: string;
  location?: string;
  className?: string;
  iconSize?: string;
  description?: string;
}

const {
  id = 'share-links',
  title: titleProp,
  url: urlProp,
  description: descProp,
  location = 'page',
  className = '',
  iconSize = 'w-1-5 h-1-5'
} = Astro.props;

const pageTitle = titleProp || Astro.props.title || '';
const pageDescription = descProp || Astro.props.description || '';
let resolvedUrl = urlProp || Astro.url?.pathname || '/';

if (!/^https?:\/\//.test(resolvedUrl)) {
  const domain = siteDefaults.siteUrl || Astro.site?.href || 'http://localhost:4321';
  resolvedUrl = new URL(resolvedUrl, domain).href;
}

const encodedURL = encodeURIComponent(resolvedUrl);
const encodedTitle = encodeURIComponent(pageTitle);

const shareLinks = siteDefaults.shareLinks ?? [];
const platforms = [
  { name: 'Whatsapp', href: `https://wa.me/?text=${encodedTitle}%20${encodedURL}` },
  { name: 'Facebook', href: `https://www.facebook.com/sharer/sharer.php?u=${encodedURL}` },
  { name: 'X', href: `https://x.com/intent/tweet?url=${encodedURL}&text=${encodedTitle}` },
  { name: 'LinkedIn', href: `https://www.linkedin.com/shareArticle?mini=true&url=${encodedURL}&title=${encodedTitle}` },
  { name: 'Reddit', href: `https://www.reddit.com/submit?url=${encodedURL}&title=${encodedTitle}` },
  { name: 'Email', href: `mailto:?subject=${encodedTitle}&body=${encodedTitle}%0A${encodedURL}` },
  { name: 'Copy Link', href: null }
];

function toId(name: string) {
  return `${location}-share-${name.toLowerCase().replace(/\s+/g, '-')}`;
}

function toIconName(name: string) {
  return name === 'Copy Link' ? 'clipboard' : name.toLowerCase().replace(/\s+/g, '-');
}
---
<nav
  id={id}
  aria-label="Share this page"
  class={`share-toolbar py-1 px-05 my-1 bg br-r ${className}`}
  data-title={pageTitle}
  data-url={resolvedUrl}
>
  {pageTitle && (
    <span class="share-title text-xs bold block mb-05 uppercase">{pageTitle}</span>
  )}

  <div role="toolbar" aria-orientation="horizontal" class="w-100p">
    <ul class="flex flex-row wrap gap ai-center no-bullets m-0 p-0" role="list">
      {shareLinks.map((name, index) => {
        const platform = platforms.find(
          (p) => p.name.toLowerCase() === name.toLowerCase()
        );
        if (!platform) return null;

        const label = `Share on ${name}`;
        const icon = toIconName(name);
        const dataId = toId(name);
        const isFirst = index === 0;

        return (
          <li
            class="icon-wrapper flex ai-center jc-center p-02 br-r fill-primary col-primary"
            role="none"
          >
            {platform.href ? (
              <a
                href={platform.href}
                target="_blank"
                rel="noopener noreferrer"
                title={label}
                aria-label={label}
                data-id={dataId}
                data-action="share"
                role="button"
                tabindex={isFirst ? '0' : '-1'}
                class="icon-link inline-flex ai-center jc-center br-r lh-0 focus-visible br-transparent hover-br hover-box-shadow p-02"
              >
                <IconMask name={icon} class={iconSize} />
              </a>
            ) : (
              <button
                type="button"
                data-id="share-copy-button"
                title="Copy Link"
                aria-label="Copy Link"
                role="button"
                tabindex={isFirst ? '0' : '-1'}
                class="icon-link col-primary inline-flex ai-center jc-center br-r lh-0 focus-visible br-transparent bg-transparent hover-br hover-box-shadow p-02"
              >
                <IconMask name="clipboard" class={iconSize} />
              </button>
            )}
          </li>
        );
      })}
    </ul>
  </div>
</nav>

