---
/**
 * src/components/consent/ConsentBanner.astro
 * Cookie / consent banner & settings modal
 * javascript external public/scripts/analytics-consent-handler.js
 */

import Button from "@/components/ui/Button.astro";
import Anchor from "@/components/ui/Anchor.astro";
import { siteFunctions } from "@/config/siteFunctions";

/* placement */
const POS = { center:'center', 'bottom-centered':'bottom-centered', 'bottom-right':'bottom-right', 'bottom-left':'bottom-left' };
const rawPos = String(siteFunctions.consent?.position ?? 'center').toLowerCase().replace(/\s+/g,'-');
const placement = POS[rawPos as keyof typeof POS] ?? 'center';

/* vendor gates */
const vendorsAllowAds = !!(siteFunctions.enableAdSense || siteFunctions.enableOtherAds);
const vendorsAllowAnalytics = !!(
  siteFunctions.googleAnalytics ||
  siteFunctions.googleTag ||
  siteFunctions.cloudflareAnalytics ||
  siteFunctions.enableCloudflareRUM
);

const c = siteFunctions.consent ?? {};
const enabled = !!c.enabled;

/* minimal, flat, short-key payload
   e  = enabled
   cn = cookie name
   ttl= cookie ttl (days)
   ag = auto-grant ms
   pcv= pre-consent pageview
   eu = EU-only (no autogrant)
   v  = version
   an = analytics default
   ads= ads default (gated by vendors)
   per= personalized ads default
   up = URL passthrough (GA)
   ar = Ads data redaction (GA)
   did= developer id (GA)
   pu = policy URL
   av = ad vendors present (bool; UI can hide Ads row if false)
*/
const cfg = {
  e:  enabled,
  cn: c.cookieName ?? "consent.v1",
  ttl: Number(c.cookieDuration ?? c.ttlDays ?? 365),
  ag:  Number(c.autograntMs ?? 120000),
  pcv: c.preConsentPageview ?? true,
  eu:  c.euOnly ?? true,
  v:   c.version ?? "1",
  an:  c.defaults?.analytics ?? vendorsAllowAnalytics,
  ads: (c.defaults?.ads ?? vendorsAllowAds) && vendorsAllowAds,
  per: c.defaults?.personalized ?? false,
  up:  c.privacy?.urlPassthrough ?? true,
  ar:  c.privacy?.adsDataRedaction ?? true,
  did: c.privacy?.developerId ?? "",
  pu:  c.policyUrl ?? "/privacy-policy/",
  av:  vendorsAllowAds ? 1 : 0
};

const consentEnabled = cfg.e;
const timer = Math.round((cfg.ag || 120000) / 1000);
---
{consentEnabled && (
  <>
    <button
      id="consent-toggler"
      class="consent-toggler fixed left-0 bottom-0 z-1000 inline-flex ai-center jc-center w-2-5 h-2-5 br-r bg br box-shadow pointer"
      aria-label="Privacy & cookie settings"
      title="Privacy & cookie settings"
    >
      <img src="/icons/privacy-shield.svg" loading="lazy" alt="privacy shield icon" width="20" height="20" aria-hidden="true" />
    </button>

    <div
      id="consent-modal"
      class="consent-modal is-hidden fixed inset-0 z-1000 overscroll-contain gap-0"
      role="dialog"
      aria-modal="true"
      aria-labelledby="consent-title"
      data-pos={placement}
      data-config={JSON.stringify(cfg)}
    >
      <div id="consent-overlay" class="consent-overlay pointer-events-auto absolute inset-0 z-0" aria-hidden="true"></div>

      <div class="consent-sheet bg col-text br br-r box-shadow max-w-featured w-95p mn-h-230 max-h-80vh overflow-hidden pointer-events-auto z-1" role="document">
        <div class="consent-header flex ai-center jc-space-between p-1 br-bottom">
          <div class="consent-title-wrap flex ai-center gap-05">
            <img class="consent-title-icon opacity-90 w-2-0 h-2-0" src="/icons/privacy-shield.svg" width="20" height="20" alt="" aria-hidden="true" />
            <h3 id="consent-title" class="consent-title m-0 text-base lh-small">Cookie preferences</h3>
          </div>
          <button id="consent-close" class="consent-close bg-transparent br w-2-0 h-2-0 br-r pointer" aria-label="Close dialog" title="Close">x</button>
        </div>

        <div class="consent-body overflow-auto px-05 py-1 overscroll-contain">
          <p class="consent-intro m-0 my-05 text-sm">
            We use cookies to keep the site secure and functional, improve services, and—if you allow—measure usage and show relevant ads.
            See our <Anchor href="/privacy-policy/">Privacy Policy</Anchor>, <Anchor href="/cookie-policy/">Cookie Policy</Anchor>,
            and Google's <a href="https://policies.google.com/technologies/partner-sites" target="_blank" rel="nofollow noopener">Privacy &amp; Terms</a>.
          </p>

          <form id="consent-form" class="consent-form flex flex-col gap-05" action="#" method="post" novalidate>
            <fieldset class="consent-group m-0 p-0 br-0">
              <legend class="consent-group-title">Your choices</legend>

              <div class="consent-row flex ai-f-start jc-space-between gap-05 px-05 pb-0">
                <label for="cb-essential-ui" class="consent-row-main flex flex-col gap-02">
                  <span class="consent-row-label bold">Essential</span>
                  <span class="consent-row-note text-sm col-base-80">Security, network, and core features.</span>
                </label>
                <input id="cb-essential-ui" type="checkbox" class="w-1-5 h-1-5 m-05" checked disabled />
              </div>

              <div class="consent-row flex ai-f-start jc-space-between gap-05 px-05 pb-0 br-top-thin-dashed">
                <label for="cb-ads-ui" class="consent-row-main flex flex-col gap-02">
                  <span class="consent-row-label bold">Advertising (basic)</span>
                  <span class="consent-row-note text-sm col-base-80">Shows ads to keep access free.</span>
                </label>
                <input id="cb-ads-ui" type="checkbox" class="w-1-5 h-1-5 m-05" checked disabled />
                <input id="cb-ads" type="checkbox" class="display-none none is-hidden hide" checked />
              </div>

              <div class="consent-row flex ai-f-start jc-space-between gap-05 px-05 pb-0 br-top-thin-dashed">
                <label for="cb-personalized" class="consent-row-main flex flex-col gap-02">
                  <span class="consent-row-label bold">Advertising (personalized)</span>
                  <span class="consent-row-note text-sm col-base-80">Use activity to tailor ads.</span>
                </label>
                <input id="cb-personalized" type="checkbox" class="w-1-5 h-1-5 m-05" />
              </div>

              <div class="consent-row flex ai-f-start jc-space-between gap-05 px-05 pb-0 br-top-thin-dashed">
                <label for="cb-analytics" class="consent-row-main flex flex-col gap-02">
                  <span class="consent-row-label bold">Analytics</span>
                  <span class="consent-row-note text-sm col-base-80">Anonymous stats to improve quality.</span>
                </label>
                <input id="cb-analytics" type="checkbox" class="w-1-5 h-1-5 m-05" />
              </div>
            </fieldset>

            {cfg.eu && (
              <p class="consent-footnote mx-05 col-base-80 text-sm italic">
                You can change your choices any time. After <span id="consent-timer-seconds">{timer}</span> seconds, default settings may apply.
              </p>
            )}

            <div class="consent-actions flex gap-05 flex-wrap mt-05">
              <Button id="consent-accept-all" variant="primary" type="button" label="Accept all">Accept all</Button>
              <Button id="consent-deny-all"   variant="secondary" type="button" label="Deny all">Deny all</Button>
              <Button id="consent-save"       variant="primary" type="button" label="Save choices">Save choices</Button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </>
)}
