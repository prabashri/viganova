---
// src/layouts/TeamLayout.astro
import BaseLayout from './BaseLayout.astro';
import { siteDefaults } from '../config/siteDefaults';
import type { HeadProps } from '../types/HeadProps';
import { Icon } from 'astro-icon/components';
import emailHashes from '../data/email-hash.json';
import ShareLink from '../components/ShareLink.astro';
import type { imageConfig } from 'astro:assets';
import FilesToLoadCSS from '@/components/FilesToLoadCSS.astro';
import FilesToLoadJS from '@/components/FilesToLoadJS.astro';

const emailHashesMap: Record<string, string> = Object.fromEntries(
  Object.entries(emailHashes).map(([slug, obj]) => [slug, obj.sha256])
);

const nonce = (Astro.locals as any).nonce;

interface Props {
  name: string;
  prefix?: string;
  role?: string;
  highestDegree?: string;
  shortBio?: string;
  experience?: number;
  expertise?: string[];
  awards?: string[];
  affiliation?: string;
  addressing?: string;
  email?: string;
  website?: string;
  joined?: string;
  left?: string;
  social?: Record<string, string>;
  featured?: boolean;
  slug?: string;
  canonicalUrl?: string;
  id?: string;
  color?: string;
  useImage?: boolean;
  useInitial?: boolean;
  initialText?: string;
  photo?: string;
  useGravatar?: boolean;
  image?: string;
  imageAlt?: string;
  profileImage?: string;
  profileImageAlt?: string;
  profileImageCaption?: string;
  profileImageTitle?: string;
}

const {
  name,
  prefix = '',
  role = '',
  highestDegree = '',
  shortBio = '',
  experience,
  expertise = [],
  awards = [],
  affiliation = '',
  addressing = '',
  email,
  website,
  joined,
  left,
  social = {},
  featured = false,
  slug = '',
  canonicalUrl,
  id = '',
  color = '',
  useImage = false,
  useInitial = false,
  initialText,
  photo = '',
  useGravatar = false,
  image,
  imageAlt,
  profileImage,
  profileImageAlt,
  profileImageCaption,
  profileImageTitle

} = Astro.props as Props;

const resolvedSlug = slug || id;
const fullCanonical = canonicalUrl || `${siteDefaults.siteUrl}/team/${resolvedSlug}/`;

const headProps: HeadProps = {
  title: `${prefix ? `${prefix} ` : ''}${name}`,
  description: shortBio || `${prefix} ${name}${role ? ` â€“ ${role}` : ''}`,
  image: profileImage
    || ((useImage && photo) ? photo : (useGravatar && resolvedSlug && emailHashesMap[resolvedSlug]
        ? `https://www.gravatar.com/avatar/${emailHashesMap[resolvedSlug]}?s=300` : undefined)),
  canonicalUrl: fullCanonical,
  index: true,
  type: 'person',

  authors: [
    {
      // id: resolvedSlug ? `${siteDefaults.siteUrl}/team/#${resolvedSlug}` : undefined,
      // slug: resolvedSlug,
      url: `/team/${resolvedSlug}/`,
      name,
      data: {
        name,
        prefix,
        role,
        highestDegree,
        shortBio,
        experience,
        expertise,
        awards,
        affiliation,
        addressing,
        email,
        website,
        joined,
        left,
        social,
        // 1:1 avatar for Person node
        image: (useImage && photo) 
          ? photo
          : (useGravatar && resolvedSlug && emailHashesMap[resolvedSlug]
              ? `https://www.gravatar.com/avatar/${emailHashesMap[resolvedSlug]}?s=300`
              : undefined),
        imageAlt,
        // 4:3 background/canvas for WebPage (optional)
        profileImage,
        profileImageAlt,
        profileImageTitle,
        profileImageCaption
      }
    }
  ]
};



let avatarSrc;
if (useImage && photo) {
  avatarSrc = { type: 'img', src: photo };
} else if (useGravatar && resolvedSlug && emailHashesMap[resolvedSlug]) {
  avatarSrc = {
    type: 'gravatar',
    src: `https://www.gravatar.com/avatar/${emailHashesMap[resolvedSlug]}?s=300`
  };
} else if (useInitial) {
  avatarSrc = {
    type: 'initial',
    color,
    text: initialText || name?.charAt(0) || '?'
  };
} else {
  avatarSrc = { type: 'icon', color };
}
---

<BaseLayout headProps={headProps}>
  <FilesToLoadCSS files={[{ name: 'team-layout', inline: true }]} />
  <FilesToLoadJS
    id="avatar-color-init"
    inline={true}
    code={`document.addEventListener('DOMContentLoaded', () => {
      document
        .querySelectorAll('.avatar-initial[data-color], .icon-avatar[data-color]')
        .forEach((el) => {
          const clr = el.getAttribute('data-color');
          if (clr) el.style.backgroundColor = clr;
        });
    });`}
  />

  <article class="team-profile" id={id}>
    <header class="team-header py-1 mx-auto bg-primary-dark col-base-00">
      <div class="max-w-content mx-auto ta-center">

        {avatarSrc.type === 'img' && <img src={avatarSrc.src} alt={`Photo of ${name}`} width="160" height="160" loading="lazy" class="team-photo" />}
        {avatarSrc.type === 'gravatar' && <img src={avatarSrc.src} alt={`Gravatar of ${name}`} width="160" height="160" loading="lazy" class="team-photo" />}
        {avatarSrc.type === 'initial' && (
          <div class="avatar-initial round ai-center jc-center mt-0 mx-auto mb-1 fs-3xl bold col-base-00" data-color={avatarSrc.color || null}>
            {avatarSrc.text}
          </div>
        )}
        {avatarSrc.type === 'icon' && (
          <Icon name="avatar" width="160" height="160" class="team-photo icon-avatar" data-color={avatarSrc.color || null} />
        )}

        <h1>{headProps.title}</h1>
        {highestDegree && <p class="team-degree">{highestDegree}</p>}
        {role && <p class="team-role bold text-xs py-05 my-05">{role}</p>}      
        {shortBio && <p class="team-short-bio">{shortBio}</p>}
      </div>
    </header>

    <section class="team-details max-w-content mx-auto my-1 py-1">
      {affiliation && <p><strong>Affiliation:</strong> {affiliation}</p>}
      {experience && <p><strong>Experience:</strong> {experience} years</p>}
      {joined && <p><strong>Joined:</strong> {new Date(joined).toLocaleDateString()}</p>}
      {addressing && <p><strong>Pronouns:</strong> {addressing}</p>}

      {expertise.length > 0 && (
        <>
          <h3>Expertise</h3>
          <ul>{expertise.map(item => <li>{item}</li>)}</ul>
        </>
      )}

      {awards.length > 0 && (
        <>
          <h3>Awards</h3>
          <ul>{awards.map(award => <li>{award}</li>)}</ul>
        </>
      )}

      {(email || website) && (
        <>
          <h3>Contact</h3>
          <ul>
            {email && <li>Email: <a href={`mailto:${email}`}>{email}</a></li>}
            {website && <li>Website: <a href={website} target="_blank" rel="noopener">{website}</a></li>}
          </ul>
        </>
      )}

      {Object.keys(social).length > 0 && (
        <>
          <h3>Social</h3>
          <ul>
            {Object.entries(social).map(([platform, url]) => (
              <li><a href={url} target="_blank" rel="noopener">{platform}</a></li>
            ))}
          </ul>
        </>
      )}
    </section>
    <ShareLink url={fullCanonical} title={`Share ${name}'s profile`} className="max-w-content mx-auto my-1" />

    <section class="team-slot-content max-w-content mx-auto my-1 py-1">      
      <slot />
    </section>
    {/*!-- Posts Section Hook */}
    <slot name="posts" />      
    </section>
  </article>
</BaseLayout>
